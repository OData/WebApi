-- GENERATED BY DatabaseCreator.cs
-- Copyright: Josh Comley, 2013
-- 04/09/2016 03:42:26
-- Also used in 'Start new project.linq'

USE [master]

-- Create data database
IF db_id('OData.Legacy.App.Data') IS NOT NULL
BEGIN
	ALTER DATABASE [OData.Legacy.App.Data] SET SINGLE_USER WITH ROLLBACK IMMEDIATE
	DROP DATABASE [OData.Legacy.App.Data]
END

-- Create standard login
DECLARE @spidstr varchar(8000)
IF EXISTS 
    (SELECT name  
     FROM master.sys.server_principals
     WHERE name = 'antiphonalLogin')
BEGIN
	SET @spidstr = NULL
	SELECT @spidstr=coalesce(@spidstr,'' )+'kill '+convert(varchar, session_id)+ '; '
	FROM sys.dm_exec_sessions WHERE login_name = 'antiphonalLogin'
	IF LEN(@spidstr) > 0
	BEGIN
		EXEC(@spidstr)
	END

	ALTER LOGIN [antiphonalLogin] DISABLE;
	DROP LOGIN [antiphonalLogin]
END

-- Create migrations login
IF EXISTS 
    (SELECT name  
     FROM master.sys.server_principals
     WHERE name = 'compliablyLogin')
BEGIN
	SET @spidstr = NULL
	SELECT @spidstr=coalesce(@spidstr,'' )+'kill '+convert(varchar, session_id)+ '; '
	FROM sys.dm_exec_sessions WHERE login_name = 'compliablyLogin'

	IF LEN(@spidstr) > 0
	BEGIN
		EXEC(@spidstr)
	END

	DROP LOGIN [compliablyLogin]
END
