-- GENERATED BY DatabaseCreator.cs
-- Copyright: Josh Comley, 2013
-- 04/05/2016 23:50:37
-- Also used in 'Start new project.linq'

USE [master]

-- Create data database
IF db_id('Microsoft.AspNetCore.OData.App.Data') IS NOT NULL
BEGIN
	ALTER DATABASE [Microsoft.AspNetCore.OData.App.Data] SET SINGLE_USER WITH ROLLBACK IMMEDIATE
	DROP DATABASE [Microsoft.AspNetCore.OData.App.Data]
END
CREATE DATABASE [Microsoft.AspNetCore.OData.App.Data]
GO

-- Create standard login
DECLARE @spidstr varchar(8000)
IF EXISTS 
    (SELECT name  
     FROM master.sys.server_principals
     WHERE name = 'roadsteadsLogin')
BEGIN
	SET @spidstr = NULL
	SELECT @spidstr=coalesce(@spidstr,'' )+'kill '+convert(varchar, session_id)+ '; '
	FROM sys.dm_exec_sessions WHERE login_name = 'roadsteadsLogin'
	IF LEN(@spidstr) > 0
	BEGIN
		EXEC(@spidstr)
	END

	ALTER LOGIN [roadsteadsLogin] DISABLE;
	DROP LOGIN [roadsteadsLogin]
END
CREATE LOGIN [roadsteadsLogin] WITH PASSWORD=N'ypN{@:2e9rfJ3/E[].:fzY4%.', DEFAULT_DATABASE=[Microsoft.AspNetCore.OData.App.Data], CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF

-- Create migrations login
IF EXISTS 
    (SELECT name  
     FROM master.sys.server_principals
     WHERE name = 'morselsLogin')
BEGIN
	SET @spidstr = NULL
	SELECT @spidstr=coalesce(@spidstr,'' )+'kill '+convert(varchar, session_id)+ '; '
	FROM sys.dm_exec_sessions WHERE login_name = 'morselsLogin'

	IF LEN(@spidstr) > 0
	BEGIN
		EXEC(@spidstr)
	END

	DROP LOGIN [morselsLogin]
END
/* END IF NO CREATE */
CREATE LOGIN [morselsLogin] WITH PASSWORD=N'PPm|Wb(An!Cb1~{}&]UPxO@nf', DEFAULT_DATABASE=[Microsoft.AspNetCore.OData.App.Data], CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF
--EXEC sp_addsrvrolemember @loginame = N'morselsLogin', @rolename = N'dbcreator'

-- Create data user
USE [Microsoft.AspNetCore.OData.App.Data]
IF EXISTS
    (SELECT name
     FROM sys.database_principals
     WHERE name = 'roadsteads')
BEGIN
	DROP USER [roadsteads]
END
CREATE USER [roadsteads] FOR LOGIN [roadsteadsLogin]
-- Configure standard user read/write permissions
EXEC SP_ADDROLEMEMBER DB_DATAREADER, [roadsteads]
EXEC SP_ADDROLEMEMBER DB_DATAWRITER, [roadsteads]
GO

-- Create data migrations user
USE [Microsoft.AspNetCore.OData.App.Data]
IF EXISTS
    (SELECT name
     FROM sys.database_principals
     WHERE name = 'morsels')
BEGIN
	DROP USER [morsels]
END
CREATE USER [morsels] FOR LOGIN [morselsLogin]
EXEC SP_ADDROLEMEMBER N'db_owner', N'morsels'
GO

